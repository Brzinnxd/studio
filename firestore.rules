/**
 * @file Firebase Security Rules for Angel's Sweets Emporium.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for customer-related data (customers and their orders),
 * while allowing public read access to product and trending flavor information. Financial transactions are not secured, and therefore should not be written to production until appropriate auth has been added.
 *
 * @data_structure
 * - /products/{productId}: Publicly readable product information.
 * - /customers/{customerId}: Customer profile data, where customerId is the user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders placed by a specific customer.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Items within a specific order.
 * - /trending_flavors/{trendingFlavorId}: Publicly readable trending flavor combinations.
 * - /business_transactions/{transactionId}: Business related financial transactions.
 * - /personal_transactions/{transactionId}: Personal financial transactions.
 *
 * @key_security_decisions
 * - Listing all users is disallowed.
 * - Read-only collections (products, trending_flavors) are publicly readable.
 * - Write access to customer and order data is restricted to the owning user (customerId in path must match request.auth.uid).
 * - Business and Personal transactions are not secured and should not be written to in production.
 *
 * @denormalization_for_authorization
 * - Orders are stored as a subcollection of /customers/{customerId}/orders/{orderId} to enable path-based ownership checks.
 *   This avoids the need for `get()` calls to verify customer ownership.
 *
 * @structural_segregation
 * - User-specific data (orders) is stored in a private subcollection under the /customers/{customerId} path.
 * - Public data (products, trending flavors) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information. Write access is denied.
     * @path /products/{productId}
     * @allow (get, list): if true
     * @deny (create, update, delete): if false
     * @principle Allows public access to product data while preventing unauthorized modifications.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows a user to read and write their own customer profile.
     * @path /customers/{customerId}
     * @allow (get, create, update, delete, list): if isOwner(customerId)
     * @deny: if !isOwner(customerId)
     * @principle Enforces document ownership: Only the authenticated user can access their own customer profile.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId);
      allow delete: if isExistingOwner(customerId);

      /**
       * @description Allows a user to read and write orders associated with their customer profile.
       * @path /customers/{customerId}/orders/{orderId}
       * @allow (get, create, update, delete, list): if isOwner(customerId)
       * @deny: if !isOwner(customerId)
       * @principle Enforces path-based ownership: Only the authenticated user can access orders associated with their customer profile.
       */
      match /orders/{orderId} {
        allow get: if isOwner(customerId);
        allow list: if isOwner(customerId);
        allow create: if isOwner(customerId);
        allow update: if isExistingOwner(customerId);
        allow delete: if isExistingOwner(customerId);

        /**
         * @description Allows a user to read and write order items associated with their order.
         * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
         * @allow (get, create, update, delete, list): if isOwner(customerId)
         * @deny: if !isOwner(customerId)
         * @principle Enforces path-based ownership: Only the authenticated user can access order items associated with their order.
         */
        match /order_items/{orderItemId} {
          allow get: if isOwner(customerId);
          allow list: if isOwner(customerId);
          allow create: if isOwner(customerId);
          allow update: if isExistingOwner(customerId);
          allow delete: if isExistingOwner(customerId);
        }
      }
    }

    /**
     * @description Allows public read access to trending flavor combinations. Write access is denied.
     * @path /trending_flavors/{trendingFlavorId}
     * @allow (get, list): if true
     * @deny (create, update, delete): if false
     * @principle Allows public access to trending flavor data while preventing unauthorized modifications.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Placeholder for business transactions security rules.  Transactions are not secured, and therefore should not be written to production.
     * @path /business_transactions/{transactionId}
     */
    match /business_transactions/{transactionId} {
      allow get: if false; // TODO: Add appropriate security rules.
      allow list: if false; // TODO: Add appropriate security rules.
      allow create: if false; // TODO: Add appropriate security rules.
      allow update: if false; // TODO: Add appropriate security rules.
      allow delete: if false; // TODO: Add appropriate security rules.
    }

    /**
     * @description Placeholder for personal transactions security rules.  Transactions are not secured, and therefore should not be written to production.
     * @path /personal_transactions/{transactionId}
     */
    match /personal_transactions/{transactionId} {
      allow get: if false; // TODO: Add appropriate security rules.
      allow list: if false; // TODO: Add appropriate security rules.
      allow create: if false; // TODO: Add appropriate security rules.
      allow update: if false; // TODO: Add appropriate security rules.
      allow delete: if false; // TODO: Add appropriate security rules.
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}