/**
 * @fileOverview Firestore Security Rules for Angel's Sweets Emporium.
 *
 * Core Philosophy:
 * This ruleset employs a hybrid security model. Public read access is granted to product and trending flavor data, while customer-specific data (customer profiles and orders) is strictly controlled via path-based ownership, ensuring that only the authenticated user can access their own information. Financial transaction data is accessible to all authenticated users but write access is disabled (TODO).
 *
 * Data Structure:
 * - /products/{productId}: Publicly readable product information.
 * - /customers/{customerId}: Customer profiles, where customerId must match the user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders associated with a specific customer. customerId must match the user's UID to be able to read or write
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Order items associated with a specific order. customerId must match the user's UID.
 * - /trending_flavors/{trendingFlavorId}: Publicly readable trending flavor data.
 * - /business_transactions/{transactionId}: Business financial transactions.
 * - /personal_transactions/{transactionId}: Personal financial transactions.
 *
 * Key Security Decisions:
 * - Products and trending flavors are publicly readable to allow for easy display.
 * - Customer profiles and orders are secured using path-based ownership, ensuring that users can only access their own data.
 * - Listing of all customers is disallowed.
 * - Listing of trending flavors and products is allowed.
 * - Financial transactions are read-only for all authenticated users (TODO).
 *
 * Denormalization for Authorization:
 * Path-based ownership is used to authorize access to customer orders, avoiding the need for additional `get()` calls to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Defines the Product entity's security rules.
     * @path /products/{productId}
     * @allow (get, list): Any user can read product information.
     * @allow (create, update, delete): No one can create, update, or delete products.
     * @deny (create): Not allowed
     * @principle Public read, admin-only write (currently no write)
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Defines the TrendingFlavor entity's security rules.
     * @path /trending_flavors/{trendingFlavorId}
     * @allow (get, list): Any user can read trending flavor information.
     * @allow (create, update, delete): No one can create, update, or delete trending flavors.
     * @deny (create): Not allowed
     * @principle Public read, admin-only write (currently no write)
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Defines the Transaction entity's security rules for business transactions.
     * @path /business_transactions/{transactionId}
     * @allow (get, list): Authenticated users can read business transaction information.
     * @allow (create, update, delete): No one can create, update, or delete business transactions.
     * @deny (create): Not allowed.
     * @principle Public read, no writes permitted.
     */
    match /business_transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

        /**
     * @description Defines the Transaction entity's security rules for personal transactions.
     * @path /personal_transactions/{transactionId}
     * @allow (get, list): Authenticated users can read personal transaction information.
     * @allow (create, update, delete): No one can create, update, or delete personal transactions.
     * @deny (create): Not allowed.
     * @principle Public read, no writes permitted.
     */
    match /personal_transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Defines the Customer entity's security rules.
     * @path /customers/{customerId}
     * @allow (get, create, update, delete): Only the customer themselves can access their profile.
     * @deny (list): Listing all customers is not allowed.
     * @principle Owner-only access to profile data.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Defines the Order entity's security rules.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get, list, create, update, delete): Only the customer who owns the order can access it.
     * @principle Path-based ownership of order data.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Defines the OrderItem entity's security rules.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (get, list, create, update, delete): Only the customer who owns the order item can access it.
     * @principle Path-based ownership of order item data.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }
  }
}