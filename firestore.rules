/**
 * @fileoverview Firestore Security Rules for Angel's Sweets Emporium.
 *
 * Core Philosophy: This ruleset enforces a user-ownership model for customer-related data (customers, orders, order items) while allowing public read access to product and trending flavor data. Financial transactions are stored in root-level collections with no owner based security.
 *
 * Data Structure:
 * - /products/{productId}: Public product catalog.
 * - /customers/{customerId}: Customer profiles, where customerId must match the user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders associated with a customer.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Order items for a specific order.
 * - /trending_flavors/{trendingFlavorId}: Public trending flavor data.
 * - /business_transactions/{transactionId}: Business financial transactions
 * - /personal_transactions/{transactionId}: Personal financial transactions
 *
 * Key Security Decisions:
 * - Products and trending flavors are publicly readable.
 * - Customers can only read/write their own profile data and their orders.
 * - No listing of all customers is allowed.
 * - Financial transactions are open to read/write
 *
 * Denormalization for Authorization:
 * - Customer ownership is enforced via path-based rules (customers/{customerId}), avoiding the need for `get()` calls to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read product information. Only allows write operations.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read access for product catalog.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

        /**
     * @description Allows anyone to read and write business transaction information.
     * @path /databases/{database}/documents/business_transactions/{transactionId}
     * @allow (create, get, list, update, delete)
     * @principle Public read/write access for business financial transactions
     */
    match /business_transactions/{transactionId} {
        allow create, get, list, update, delete: if true;
    }

    /**
     * @description Allows anyone to read and write personal transaction information.
     * @path /databases/{database}/documents/personal_transactions/{transactionId}
     * @allow (create, get, list, update, delete)
     * @principle Public read/write access for personal financial transactions
     */
    match /personal_transactions/{transactionId} {
        allow create, get, list, update, delete: if true;
    }

    /**
     * @description Allows a user to read and write their own customer profile.
     * @path /databases/{database}/documents/customers/{customerId}
     * @allow (create, get, update, delete) for the owner.
     * @deny (list)
     * @deny (create, get, update, delete) for others.
     * @principle Enforces document ownership for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isSelfCreation(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to manage their own orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}
     * @allow (create, get, list, update, delete) for the owner (customerId).
     * @deny (create, get, list, update, delete) for others.
     * @principle Enforces document ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to manage their own order items within their orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (create, get, list, update, delete) for the owner (customerId).
     * @deny (create, get, list, update, delete) for others.
     * @principle Enforces document ownership for order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows anyone to read trending flavor information. Only allows write operations.
     * @path /databases/{database}/documents/trending_flavors/{trendingFlavorId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read access for trending flavor data.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isSelfCreation(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
  }
}