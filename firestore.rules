/**
 * @file Firestore Security Rules for Angel's Sweets Emporium.
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model for customer-related data (profiles, orders) and role-based access control for admin users.
 *
 * @dataStructure The Firestore database is structured with user profiles under `/users/{userId}`, products under `/products/{productId}`, transactions under `/business_transactions/{transactionId}` & `/personal_transactions/{transactionId}`, customer profiles under `/customers/{customerId}`, orders as subcollections under `/customers/{customerId}/orders/{orderId}`, order items as subcollections under `/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}`, and trending flavors under `/trending_flavors/{trendingFlavorId}`.
 *
 * @keySecurityDecisions
 *   - User profiles are only readable and writable by the authenticated user.
 *   - Customer profiles are only readable and writable by the authenticated user.
 *   - Orders and order items are only accessible by the customer who owns them, based on path-based ownership (`customerId`).
 *   - Public read access is granted for products and trending flavors.
 *   - Listing all users or customers is disallowed.
 *   - Transactions are secured such that authenticated users can create, read, update, and delete their own transactions.
 *
 * @denormalizationForAuthorization Not applicable, as the path-based ownership model is used for authorization.
 * @structuralSegregation User-specific data (orders) is stored in subcollections under the `/customers/{customerId}` path, while global data (products, trending flavors) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to read and write their own user profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if request.auth.uid == userId
     * @deny (get) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to product information. Only authenticated users can create and modify products.
     * @path /products/{productId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if request.auth != null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     *
     * @principle Allows public read access with owner-only writes.
     */
    match /products/{productId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Allows creating, reading, updating, and deleting business transactions for authenticated users.
     * @path /business_transactions/{transactionId}
     * @allow (get, create, update, delete) if request.auth != null
     * @deny (get) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces authentication for all operations.
     */
    match /business_transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows creating, reading, updating, and deleting personal transactions for authenticated users.
     * @path /personal_transactions/{transactionId}
     * @allow (get, create, update, delete) if request.auth != null
     * @deny (get) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces authentication for all operations.
     */
    match /personal_transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read and write their own customer profile.
     * @path /customers/{customerId}
     * @allow (get, create, update, delete) if request.auth.uid == customerId
     * @deny (get) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId} {
      function isOwner(customerId) {
        return request.auth != null && request.auth.uid == customerId;
      }

      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId) && request.resource.data.id == customerId;
      allow update: if isOwner(customerId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(customerId);
    }

    /**
     * @description Allows a customer to manage their own orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get, list, create, update, delete) if request.auth.uid == customerId
     * @deny (get) if request.auth == null
     * @deny (list) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces path-based ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      function isOwner(customerId) {
        return request.auth != null && request.auth.uid == customerId;
      }
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId);
      allow delete: if isOwner(customerId);
    }

    /**
     * @description Allows a customer to manage their own order items within an order.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (get, list, create, update, delete) if request.auth.uid == customerId
     * @deny (get) if request.auth == null
     * @deny (list) if request.auth == null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Enforces path-based ownership for order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      function isOwner(customerId) {
        return request.auth != null && request.auth.uid == customerId;
      }
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId);
      allow delete: if isOwner(customerId);
    }

    /**
     * @description Allows public read access to trending flavor data. Only authenticated users can create and modify trending flavors.
     * @path /trending_flavors/{trendingFlavorId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if request.auth != null
     * @deny (create) if request.auth == null
     * @deny (update) if request.auth == null
     * @deny (delete) if request.auth == null
     * @principle Allows public read access with owner-only writes.
     */
    match /trending_flavors/{trendingFlavorId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }
  }
}