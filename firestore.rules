/**
 * @fileoverview Firestore Security Rules for Angel's Sweets Emporium.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer-related data
 * (customers and their orders), while allowing public read access to product and
 * trending flavor information. Business and personal transaction information is
 * also publicly accessible.
 *
 * Data Structure:
 * - /products/{productId}: Product catalog, publicly readable.
 * - /customers/{customerId}: Customer profiles, owner-only access.
 * - /customers/{customerId}/orders/{orderId}: Orders for a specific customer, owner-only access.
 * - /trending_flavors/{trendingFlavorId}: Trending flavor data, publicly readable.
 * - /business_transactions/{transactionId}: Business financial transactions, publicly readable.
 * - /personal_transactions/{transactionId}: Personal financial transactions, publicly readable.
 *
 * Key Security Decisions:
 * - Customers can only create, read, update, and delete their own profiles and orders.
 * - Products, Trending Flavors, Business Transactions, and Personal Transactions are publicly readable.
 * - Listing of customer documents is disabled to protect user privacy.
 * - Data validation is minimized for rapid prototyping, focusing only on ownership checks.
 *
 * Denormalization for Authorization:
 * - Customer ownership is enforced via path-based rules on the /customers/{customerId} collection and its subcollections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /products collection.
     * @path /products/{productId}
     * @allow (get, list): Any user can read product information.
     * @allow (create, update, delete): No one can modify product information.
     * @deny (create): Prevents unauthorized product creation.
     * @principle Public read, no writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for the /business_transactions collection.
     * @path /business_transactions/{transactionId}
     * @allow (get, list): Any user can read transaction information.
     * @allow (create, update, delete): No one can modify transaction information.
     * @deny (create): Prevents unauthorized transaction creation.
     * @principle Public read, no writes.
     */
    match /business_transactions/{transactionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

        /**
     * @description Rules for the /personal_transactions collection.
     * @path /personal_transactions/{transactionId}
     * @allow (get, list): Any user can read transaction information.
     * @allow (create, update, delete): No one can modify transaction information.
     * @deny (create): Prevents unauthorized transaction creation.
     * @principle Public read, no writes.
     */
    match /personal_transactions/{transactionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for the /customers collection.
     * @path /customers/{customerId}
     * @allow (get, update, delete): Only the customer can access their own profile.
     * @allow (create): A user can create their own profile if the customerId matches their auth UID.
     * @deny (list): Listing of customer documents is not allowed.
     * @principle Owner-only access for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders collection.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get, update, delete): Only the customer can access their own orders.
     * @allow (create): A user can create an order under their customer ID.
     * @deny: Any other operation is denied.
     * @principle Owner-only access for customer orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders/{orderId}/order_items collection.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (get, update, delete): Only the customer can access their own order items.
     * @allow (create): A user can create an order item under their customer ID and order ID.
     * @deny: Any other operation is denied.
     * @principle Owner-only access for customer order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /trending_flavors collection.
     * @path /trending_flavors/{trendingFlavorId}
     * @allow (get, list): Any user can read trending flavor information.
     * @allow (create, update, delete): No one can modify trending flavor information.
     * @deny (create): Prevents unauthorized trending flavor creation.
     * @principle Public read, no writes.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}