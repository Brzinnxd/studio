/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for customer-related data (customers and orders),
 * and allows public read access to product and trending flavor information. Financial transactions (business and personal) are not accessible.
 *
 * @data-structure
 * - /products/{productId}: Public product catalog.
 * - /customers/{customerId}: Customer profiles, where customerId must match the user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders belonging to a specific customer.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Order items belonging to a specific order.
 * - /trending_flavors/{trendingFlavorId}: Public list of trending flavor combinations.
 * - /business_transactions/{transactionId}: Financial transactions for the business. Not intended to be accessible.
 * - /personal_transactions/{transactionId}: Personal financial transactions. Not intended to be accessible.
 *
 * @key-security-decisions
 * - Listing all customers is disallowed to protect user privacy.
 * - Only the authenticated user can create, update, or delete their own customer profile and orders.
 * - Products and trending flavors are publicly readable, but writes are disallowed.
 * - Business and personal transactions are not accessible via the client, requiring server-side management.
 *
 * @denormalization-for-authorization
 * - The customerId is embedded in the path for orders (/customers/{customerId}/orders/{orderId}) to enable simple path-based ownership checks without needing additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information, but restricts all writes.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get, list): Any user can read product information.
     * @deny (create, update, delete): No user can create, update, or delete product information via client.
     * @principle Public read, no client writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows users to manage their own customer profile.
     * @path /databases/{database}/documents/customers/{customerId}
     * @allow (create): Authenticated user can create their profile if the customerId matches their UID.
     * @allow (get, update, delete): Authenticated user can read, update, or delete their profile if the customerId matches their UID and the document exists.
     * @deny (list): Listing all customers is not allowed.
     * @principle Enforces document ownership for writes and prevents listing all users.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows users to manage their own orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}
     * @allow (create): Authenticated user can create an order if the customerId matches their UID.
     * @allow (get, list, update, delete): Authenticated user can read, list, update, or delete their own orders if the customerId matches their UID and the document exists.
     * @deny: Attempts to create, update, or delete orders for other customers will be rejected.
     * @principle Enforces path-based ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows users to manage their own order items within their own orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (create): Authenticated user can create an order item if the customerId matches their UID.
     * @allow (get, list, update, delete): Authenticated user can read, list, update, or delete their own order items if the customerId matches their UID and the document exists.
     * @deny: Attempts to create, update, or delete order items for other customers will be rejected.
     * @principle Enforces path-based ownership for order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows public read access to trending flavor information, but restricts all writes.
     * @path /databases/{database}/documents/trending_flavors/{trendingFlavorId}
     * @allow (get, list): Any user can read trending flavor information.
     * @deny (create, update, delete): No user can create, update, or delete trending flavor information.
     * @principle Public read, no client writes.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Disallows all access to business transactions.
     * @path /databases/{database}/documents/business_transactions/{transactionId}
     * @deny (get, list, create, update, delete): No user can access business transaction information via the client.
     * @principle Prevents client-side access to sensitive data.
     */
    match /business_transactions/{transactionId} {
      allow get, list, create, update, delete: if false;
    }

    /**
     * @description Disallows all access to personal transactions.
     * @path /databases/{database}/documents/personal_transactions/{transactionId}
     * @deny (get, list, create, update, delete): No user can access personal transaction information.
     * @principle Prevents client-side access to sensitive data.
     */
    match /personal_transactions/{transactionId} {
      allow get, list, create, update, delete: if false;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of an EXISTING document.
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}