/**
 * @file Firestore Security Rules for Angel's Sweets Emporium.
 *
 * @corePhilosophy This ruleset enforces a user-ownership model for customer-related data (orders)
 *   and allows public read access to product and trending flavor data. Financial transactions,
 *   both business and personal, are locked down to prevent unauthorized access.
 *
 * @dataStructure The data is organized into top-level collections for products, business transactions,
 *   personal transactions, and trending flavors. Customer profiles are stored under /customers/{customerId},
 *   with orders as a subcollection under each customer: /customers/{customerId}/orders/{orderId}. Order items are
 *   nested further: /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}.
 *
 * @keySecurityDecisions
 *   - Users can only manage their own customer profiles and associated orders.
 *   - Listing of customers is disallowed.
 *   - Products and trending flavors are publicly readable.
 *   - Financial transactions are strictly controlled to prevent unauthorized modifications.
 *
 * @denormalizationForAuthorization N/A - Path-based ownership is used for orders, avoiding the need
 *   for denormalization.  The `customerId` is present in the path `/customers/{customerId}/orders/{orderId}`,
 *   which allows rules to directly check `request.auth.uid == customerId`.
 *
 * @structuralSegregation User-specific data (orders) is stored in a subcollection under the user's
 *   customer document, while global data (products, trending flavors) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information. Only allows authenticated users to create, update, or delete products.
     * @path /databases/{database}/documents/products/{productId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn();
     * @allow delete: if isSignedIn();
     * @deny create: if false;
     * @deny update: if false;
     * @deny delete: if false;
     * @principle Allows public read access for products while restricting write access to authenticated users.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to manage business transactions.
     * @path /databases/{database}/documents/business_transactions/{transactionId}
     * @allow get: if false;
     * @allow list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if isSignedIn() && resource != null;
     * @deny get: if true;
     * @deny list: if true;
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if false;
     * @principle Restricts access to business transactions for all operations.
     */
    match /business_transactions/{transactionId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows authenticated users to manage personal transactions.
     * @path /databases/{database}/documents/personal_transactions/{transactionId}
     * @allow get: if false;
     * @allow list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if isSignedIn() && resource != null;
     * @deny get: if true;
     * @deny list: if true;
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if false;
     * @principle Restricts access to personal transactions for all operations.
     */
    match /personal_transactions/{transactionId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows a user to create, read, update, and delete their own customer profile.
     * @path /databases/{database}/documents/customers/{customerId}
     * @allow get: if isOwner(customerId);
     * @allow list: if false;
     * @allow create: if isOwner(customerId);
     * @allow update: if isOwner(customerId) && resource != null;
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if true;
     * @deny create: if !isOwner(customerId);
     * @deny update: if !isOwner(customerId);
     * @deny delete: if !isOwner(customerId);
     * @principle Enforces document ownership for customer profiles, restricting access to the owner.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId) && resource != null;
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a user to manage their own orders under their customer profile.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow create: if isOwner(customerId);
     * @allow update: if isOwner(customerId) && resource != null;
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if !isOwner(customerId);
     * @deny create: if !isOwner(customerId);
     * @deny update: if !isOwner(customerId);
     * @deny delete: if !isOwner(customerId);
     * @principle Enforces document ownership for orders, restricting access to the owner.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId) && resource != null;
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a user to manage order items within their own orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow create: if isOwner(customerId);
     * @allow update: if isOwner(customerId) && resource != null;
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if !isOwner(customerId);
     * @deny create: if !isOwner(customerId);
     * @deny update: if !isOwner(customerId);
     * @deny delete: if !isOwner(customerId);
     * @principle Enforces document ownership for order items, restricting access to the owner.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isOwner(customerId) && resource != null;
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows public read access to trending flavor data. Only allows authenticated users to create, update, or delete trending flavors.
     * @path /databases/{database}/documents/trending_flavors/{trendingFlavorId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn();
     * @allow delete: if isSignedIn();
     * @deny create: if false;
     * @deny update: if false;
     * @deny delete: if false;
     * @principle Allows public read access for trending flavors while restricting write access to authenticated users.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }

  // Helper Functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}