/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for customer-related data (customers and orders),
 * and allows public read access to product and trending flavor information. Financial transactions
 * are separated into business and personal contexts for clarity and access control.
 *
 * @dataStructure
 * - /products/{productId}: Publicly readable product catalog.
 * - /customers/{customerId}: Customer profiles, with customerId matching the user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders belonging to a specific customer.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Items within a specific order
 * - /trending_flavors/{trendingFlavorId}: Publicly readable data on trending flavors.
 * - /business_transactions/{transactionId}: Business-related financial transactions.
 * - /personal_transactions/{transactionId}: Personal financial transactions.
 *
 * @keySecurityDecisions
 * - Customers can only access their own profile data and orders.
 * - Products and trending flavors are publicly readable but not writable by clients.
 * - No user listing is allowed for the customers collection.
 * - Write access to all collections is restricted to authenticated users with proper authorization.
 *
 * @denormalizationForAuthorization
 * - CustomerId is present in the path of the orders subcollection. This avoids the need for `get()` calls
 *   to verify customer ownership when accessing orders.
 *
 * @structuralSegregation
 * - Orders are stored as a subcollection of customers, providing clear ownership and efficient querying
 *   for a specific customer's order history. Business and personal transactions are in separate root collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows public read access to product information, but restricts write access.
     * @path /products/{productId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, owner-only writes (backend only in this case)
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Allows read and write access to business transactions for authenticated users.
      * @path /business_transactions/{transactionId}
      * @allow create: if isSignedIn();
      * @allow get, list: if isSignedIn();
      * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      * @principle Authenticated users only, owner-only writes with existence check
      */
     match /business_transactions/{transactionId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     }

      /**
       * @description Allows read and write access to personal transactions for authenticated users.
       * @path /personal_transactions/{transactionId}
       * @allow create: if isSignedIn();
       * @allow get, list: if isSignedIn();
       * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
       * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
       * @principle Authenticated users only, owner-only writes with existence check
       */
      match /personal_transactions/{transactionId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      }


    /**
     * @description Allows a user to create, read, update, and delete their own customer profile.
     * @path /customers/{customerId}
     * @allow create: if request.auth.uid == customerId;
     * @allow get: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @deny list: if true;
     * @principle Enforces document ownership for all operations.  No listing allowed.
     */
    match /customers/{customerId} {
      allow create: if isOwner(customerId);
      allow get: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
      allow list: if false;
    }

    /**
     * @description Allows a customer to create, read, update, and delete their own orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow create: if isOwner(customerId);
     * @allow get: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @principle Enforces document ownership for all operations within a user's data tree.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow create: if isOwner(customerId);
      allow get: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
      allow list: if isOwner(customerId);
    }

    /**
     * @description Allows a customer to create, read, update, and delete their own order items.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow create: if isOwner(customerId);
     * @allow get: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @principle Enforces document ownership for all operations within a user's data tree.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow create: if isOwner(customerId);
      allow get: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
      allow list: if isOwner(customerId);
    }

    /**
     * @description Allows public read access to trending flavor data, but restricts write access.
     * @path /trending_flavors/{trendingFlavorId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, owner-only writes (backend only in this case)
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}