/**
 * @file Firebase Security Rules for Angel's Sweets Emporium.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for customer-related data (customers and their orders),
 * while allowing public read access to product and trending flavor information. Financial transactions are not user-scoped and need further access control.
 *
 * @data_structure
 * - /products/{productId}: Public product catalog.
 * - /customers/{customerId}: Customer profiles, where customerId MUST match the authenticated user's UID.
 * - /customers/{customerId}/orders/{orderId}: Orders belonging to a specific customer.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Items within a specific order.
 * - /trending_flavors/{trendingFlavorId}: Public trending flavor data.
 * - /business_transactions/{transactionId}: Business financial transactions.
 * - /personal_transactions/{transactionId}: Personal financial transactions.
 *
 * @key_security_decisions
 * - Customers can only access their own profile data and orders.
 * - Products and trending flavors are publicly readable.
 * - Listing all customer profiles or all transactions is disallowed.
 * - Write access to financial transactions is denied and must be explicitly granted.
 * - Data validation is relaxed in this prototyping phase, focusing on authorization and relational integrity only.
 *
 * @denormalization_for_authorization
 * - CustomerId in the /customers/{customerId}/orders/{orderId} path is used to enforce ownership, avoiding `get()` calls to the customer document.
 *
 * @structural_segregation
 * - Customer-specific order data is stored in a subcollection to provide path-based authorization and efficient list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information. Write access is denied and requires further authorization.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get, list) Allows any user to read product information.
     * @deny (create, update, delete) Denies any user to write product information.
     * @principle Public read, restricted write.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add authorization logic for product management.
    }

    /**
     * @description Allows read/write access to a customer's profile only to the authenticated user with matching UID.
     * @path /databases/{database}/documents/customers/{customerId}
     * @allow (create) Allows a user to create their own customer profile if the customerId matches their UID.
     * @allow (get, update, delete) Allows a user to read, update, or delete their own customer profile if the customerId matches their UID.
     * @deny (create, update, delete) Denies a user from creating, updating, or deleting another user's profile.
     * @deny (list) Listing customer profiles is disallowed.
     * @principle Enforces document ownership for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows read/write access to orders only to the authenticated user who owns the customer profile.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}
     * @allow (create, get, list, update, delete) Allows a user to create, read, list, update, or delete their own orders if the customerId matches their UID.
     * @deny (create, get, list, update, delete) Denies a user from creating, reading, listing, updating, or deleting another user's orders.
     * @principle Enforces document ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows read/write access to order items only to the authenticated user who owns the customer profile.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     *  @allow (create, get, list, update, delete) Allows a user to create, read, list, update, or delete order items for their own orders.
     *  @deny (create, get, list, update, delete) Denies a user from creating, reading, listing, updating, or deleting order items for another user's orders.
     * @principle Enforces document ownership for order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows public read access to trending flavor data. Write access is denied and requires further authorization.
     * @path /databases/{database}/documents/trending_flavors/{trendingFlavorId}
     * @allow (get, list) Allows any user to read trending flavor data.
     * @deny (create, update, delete) Denies any user to write trending flavor data.
     * @principle Public read, restricted write.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add authorization logic for trending flavor management.
    }

    /**
     * @description Denies all access to business financial transactions. Authorization logic must be added.
     * @path /databases/{database}/documents/business_transactions/{transactionId}
     * @deny (create, get, list, update, delete) Denies all access.
     * @principle Requires explicit authorization.
     */
    match /business_transactions/{transactionId} {
      allow get, list, create, update, delete: if false; // TODO: Add authorization logic for business transactions.
    }

    /**
     * @description Denies all access to personal financial transactions. Authorization logic must be added.
     * @path /databases/{database}/documents/personal_transactions/{transactionId}
     * @deny (create, get, list, update, delete) Denies all access.
     * @principle Requires explicit authorization.
     */
    match /personal_transactions/{transactionId} {
      allow get, list, create, update, delete: if false; // TODO: Add authorization logic for personal transactions.
    }

  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
  }
}