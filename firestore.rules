/**
 * @file Firestore Security Rules for Angel's Sweets Emporium.
 *
 * @corePhilosophy This ruleset employs a hybrid security model. Product and trending flavor data is publicly readable, but only authorized users can modify it. Customer and order data is strictly user-owned and only accessible by the respective customer. Business and personal transaction data is only accessible to signed-in users.
 * @dataStructure The database is organized into top-level collections for products, trending flavors, business transactions, personal transactions, and customers. Orders are stored as subcollections under each customer's document.
 * @keySecurityDecisions Listing of customer documents is disallowed to prevent data exposure. Read access to products and trending flavors is public to facilitate display and analysis. Write access to these collections should be protected by a more sophisticated role-based mechanism in a production environment. User-owned data (customers and orders) is strictly enforced using path-based ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read product information. Write access is not granted in this prototype.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Allows public read access to product information.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Implement more restrictive write rules.
    }

    /**
     * @description Allows anyone to read trending flavor information. Write access is not granted in this prototype.
     * @path /databases/{database}/documents/trending_flavors/{trendingFlavorId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Allows public read access to trending flavor analysis.
     */
    match /trending_flavors/{trendingFlavorId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Implement more restrictive write rules.
    }

    /**
     * @description Allows a signed-in user to create business transactions.
     * @path /databases/{database}/documents/business_transactions/{transactionId}
     * @allow create: if isSignedIn();
     * @allow get, list: if isSignedIn();
     * @deny update, delete: if false;
     * @principle Enforces that only signed-in users can create business transactions.
     */
    match /business_transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows a signed-in user to create personal transactions.
     * @path /databases/{database}/documents/personal_transactions/{transactionId}
     * @allow create: if isSignedIn();
     * @allow get, list: if isSignedIn();
     * @deny update, delete: if false;
     * @principle Enforces that only signed-in users can create personal transactions.
     */
    match /personal_transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows a user to create their own customer profile, and read/write their own profile data.
     * @path /databases/{database}/documents/customers/{customerId}
     * @allow create: if isOwner(customerId);
     * @allow get: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @deny list
     * @principle Enforces document ownership for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to create, read, update, and delete their own orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}
     * @allow create: if isOwner(customerId);
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @principle Enforces path-based ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to create, read, update and delete their own order items within their orders.
     * @path /databases/{database}/documents/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow create: if isOwner(customerId);
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @principle Enforces path-based ownership for order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}